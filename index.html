<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Szpital - Misja Lekarska</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; margin: 0; padding: 20px; box-sizing: border-box; display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        #gameContainer { position: relative; display: flex; flex-direction: row; border: 3px solid #4a5568; border-radius: 20px; background: white; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; max-width: 1200px; max-height: 800px; }
        #canvasWrapper { display: flex; align-items: center; justify-content: center; background: #f7fafc; }
        canvas { display: block; background: #f7fafc; box-shadow: 0 0 8px #e2e8f0; border-radius: 0 20px 20px 0; }
        #ui-panel { width: 320px; min-width: 320px; padding:24px; background:linear-gradient(180deg,#4a5568 0%,#2d3748 100%); color:white; display:flex; flex-direction:column; gap:20px; }
        .info-box { background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); padding:20px; border-radius:12px; backdrop-filter:blur(10px); }
        .info-box h2 { font-size:16px; font-weight:600; margin-bottom:16px; color:#90cdf4; text-align:center; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:8px; }
        .resource { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; font-size:14px; font-weight:500; }
        .resource .value { color:#fbbf24; font-weight:700; font-size:16px; }
        .controls { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:12px; }
        .control-key { background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); padding:8px; border-radius:6px; text-align:center; font-size:12px; font-weight:500; }
        #modal-container { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:100; backdrop-filter:blur(5px); }
        #modal-content { background:white; padding:32px; border-radius:20px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.3); max-width:500px; margin:20px; }
        #modal-message { font-size:18px; font-weight:600; color:#2d3748; margin-bottom:16px; }
        #modal-question { font-size:16px; color:#4a5568; margin-bottom:24px; line-height:1.5; padding:16px; background:#f7fafc; border-radius:12px; border-left:4px solid #4299e1; text-align: left; }
        .modal-button { margin: 8px 0; padding: 12px 24px; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; transition:all .2s; width: 100%; }
        .option-button { background:#e2e8f0; color:#2d3748; } .option-button:hover { background:#cbd5e0; }
        .ok-button { background:#4299e1; color:white; } .ok-button:hover { background:#3182ce; }
        #modal-feedback { margin-top:20px; padding:16px; border-radius:12px; font-weight:600; display: none; }
        .feedback-correct { background:#c6f6d5; color:#22543d; border:1px solid #9ae6b4; }
        .feedback-incorrect { background:#fed7d7; color:#742a2a; border:1px solid #fc8181; }
    </style>
</head>
<body>
<div id="gameContainer">
    <div id="canvasWrapper">
        <canvas id="gameCanvas"></canvas>
    </div>
    <div id="ui-panel">
        <div class="info-box"><h2>ğŸ¥ Status Lekarza</h2><div class="resource"><span>ğŸ§  Wiedza:</span><span id="knowledge" class="value">0</span></div><div class="resource"><span>ğŸ’Š Leki:</span><span id="meds" class="value">0</span></div></div>
        <div class="info-box"><h2>ğŸ® Sterowanie</h2><p>UÅ¼ywaj strzaÅ‚ek do poruszania siÄ™</p><div class="controls"><div class="control-key">â†‘</div><div class="control-key">â†</div><div class="control-key">â†“</div><div class="control-key">â†’</div></div></div>
        <div class="info-box"><h2>ğŸ¯ Misja</h2><p>PomÃ³Å¼ wszystkim pacjentom, wykorzystujÄ…c swojÄ… wiedzÄ™ i zebrane leki.</p></div>
        <div class="info-box"><h2>ğŸ“Š PostÄ™p</h2><p>Wyleczeni pacjenci: <span id="patients-progress">0/0</span></p></div>
    </div>
    <div id="modal-container">
        <div id="modal-content">
            <div id="modal-message"></div>
            <div id="modal-question"></div>
            <div id="modal-buttons"></div>
            <div id="modal-feedback"></div>
            <button id="modal-ok" class="modal-button ok-button" style="display:none;">Kontynuuj</button>
        </div>
    </div>
</div>
<script>
// =================================================================================
// BAZA WIEDZY MEDYCZNEJ
// =================================================================================
const medicalData = [
    { id: 1, name: "Zaburzenia spostrzegania (omamy)", recommended: ["Rysperydon", "Olanzapina"], contraindicated: ["Lewodopa", "Kortykosteroidy"], info: "Leki przeciwpsychotyczne (Rysperydon, Olanzapina) blokujÄ… receptory dopaminy i serotoniny, hamujÄ…c omamy. Lewodopa i kortykosteroidy mogÄ… je nasilaÄ‡." },
    { id: 2, name: "Zaburzenia pamiÄ™ci", recommended: ["Donepezil", "Riwastygmina"], contraindicated: ["Benzodiazepiny", "Amitryptylina"], info: "Inhibitory acetylocholinesterazy (Donepezil) zwiÄ™kszajÄ… iloÅ›Ä‡ acetylocholiny, wspomagajÄ…c pamiÄ™Ä‡. Benzodiazepiny i leki antycholinergiczne pogarszajÄ… funkcje poznawcze." },
    { id: 3, name: "Zaburzenia myÅ›lenia (urojenia)", recommended: ["Klozapina", "Haloperidol"], contraindicated: ["Amfetamina", "Kortykosteroidy"], info: "Neuroleptyki (Klozapina, Haloperidol) blokujÄ… receptory dopaminy, opanowujÄ…c urojenia. Stymulanty i kortykosteroidy mogÄ… je pogÅ‚Ä™biaÄ‡." },
    { id: 4, name: "Zaburzenia aktywnoÅ›ci ruchowej", recommended: ["Lorazepam", "Haloperidol"], contraindicated: ["TLPD", "Depotowe neuroleptyki"], info: "Lorazepam redukuje napiÄ™cie katatoniczne, a Haloperidol hamuje pobudzenie. Leki przeciwdepresyjne trÃ³jpierÅ›cieniowe (TLPD) mogÄ… nasilaÄ‡ pobudzenie." },
    { id: 5, name: "Zaburzenia woli i dziaÅ‚ania", recommended: ["Sertralina", "Aripiprazol"], contraindicated: ["Leki antycholinergiczne", "Barbiturany"], info: "SSRI (Sertralina) i Aripiprazol poprawiajÄ… napÄ™d i motywacjÄ™. Leki antycholinergiczne i barbiturany nasilajÄ… deficyty poznawcze i brak kontroli." },
    { id: 6, name: "Zaburzenia uczuciowoÅ›ci (depresja, mania)", recommended: ["Fluoksetyna", "Lit"], contraindicated: ["Reboksetyna", "Kortykosteroidy"], info: "SSRI (Fluoksetyna) i stabilizatory nastroju (Lit) leczÄ… depresjÄ™ i maniÄ™. Kortykosteroidy mogÄ… wywoÅ‚aÄ‡ maniÄ™." },
    { id: 7, name: "Zaburzenia Å›wiadomoÅ›ci (delirium)", recommended: ["Haloperidol", "Rysperydon"], contraindicated: ["Benzodiazepiny", "Leki antycholinergiczne"], info: "Haloperidol skutecznie hamuje objawy delirium. Benzodiazepiny i leki antycholinergiczne pogÅ‚Ä™biajÄ… zaburzenia Å›wiadomoÅ›ci." },
    { id: 8, name: "Zaburzenia nawykÃ³w i popÄ™dÃ³w", recommended: ["Naltrekson", "Fluoksetyna"], contraindicated: ["Amfetamina", "Barbiturany"], info: "Naltrekson i SSRI (Fluoksetyna) zmniejszajÄ… przymus i impulsywnoÅ›Ä‡. Amfetamina i barbiturany nasilajÄ… ryzykowne zachowania." },
    { id: 9, name: "Choroba Alzheimera", recommended: ["Donepezil", "Memantyna"], contraindicated: ["Leki antycholinergiczne", "Benzodiazepiny"], info: "Donepezil i Memantyna poprawiajÄ… funkcje poznawcze i chroniÄ… komÃ³rki nerwowe. Leki antycholinergiczne i benzodiazepiny pogarszajÄ… stan pacjenta." },
    { id: 10, name: "OtÄ™pienie naczyniowe", recommended: ["Kwasy omega-3", "Galantamina"], contraindicated: ["Leki antycholinergiczne", "Neuroleptyki klasyczne"], info: "Galantamina poprawia funkcje poznawcze. Neuroleptyki klasyczne zwiÄ™kszajÄ… ryzyko incydentÃ³w naczyniowych." },
    { id: 11, name: "OtÄ™pienie mieszane", recommended: ["Riwastygmina", "Memantyna"], contraindicated: ["Benzodiazepiny", "Leki antycholinergiczne"], info: "Riwastygmina i Memantyna dziaÅ‚ajÄ… korzystnie w obu typach otÄ™pienia. Benzodiazepiny i leki antycholinergiczne nasilajÄ… objawy." },
    { id: 12, name: "OtÄ™pienie z ciaÅ‚ami Lewyâ€™ego", recommended: ["Riwastygmina", "Donepezil"], contraindicated: ["Haloperidol", "Olanzapina"], info: "Riwastygmina i Donepezil poprawiajÄ… funkcje poznawcze. Haloperidol i Olanzapina mogÄ… wywoÅ‚aÄ‡ ciÄ™Å¼kie powikÅ‚ania ruchowe." },
    { id: 13, name: "OtÄ™pienie czoÅ‚owo-skroniowe", recommended: ["Trazodon", "Sertralina"], contraindicated: ["Inhibitory cholinesterazy", "Klozapina"], info: "Trazodon i SSRI redukujÄ… zaburzenia zachowania. Inhibitory cholinesterazy sÄ… nieskuteczne i mogÄ… nasilaÄ‡ pobudzenie." },
];

const drugInfos = {
    "Rysperydon": "Atypowy lek przeciwpsychotyczny. Blokuje receptory dopaminy (D2) i serotoniny, skutecznie hamujÄ…c omamy i objawy psychotyczne.",
    "Olanzapina": "Atypowy lek przeciwpsychotyczny. DziaÅ‚a podobnie do Rysperydonu, stabilizujÄ…c nastrÃ³j i redukujÄ…c objawy psychotyczne.",
    "Donepezil": "Inhibitor acetylocholinesterazy. ZwiÄ™ksza iloÅ›Ä‡ neuroprzekaÅºnika acetylocholiny w mÃ³zgu, co wspomaga pamiÄ™Ä‡ i funkcje poznawcze.",
    "Riwastygmina": "Podobnie jak Donepezil, jest inhibitorem acetylocholinesterazy. Stosowana w otÄ™pieniu typu Alzheimera, Parkinsona i z ciaÅ‚ami Lewy'ego.",
    "Klozapina": "Bardzo skuteczny neuroleptyk, stosowany w lekoopornej schizofrenii. Pomaga w opanowaniu urojeÅ„ i dezorganizacji myÅ›lenia.",
    "Haloperidol": "Klasyczny neuroleptyk, silnie blokujÄ…cy receptory dopaminowe. Skuteczny w stanach ostrego pobudzenia, delirium i psychozach.",
    "Lorazepam": "Benzodiazepina o dziaÅ‚aniu przeciwlÄ™kowym, uspokajajÄ…cym i przeciwdrgawkowym. Skutecznie redukuje napiÄ™cie i objawy katatonii.",
    "Sertralina": "Lek z grupy SSRI (inhibitor wychwytu zwrotnego serotoniny). Poprawia nastrÃ³j, zmniejsza natrÄ™ctwa i objawy depresji.",
    "Aripiprazol": "Neuroleptyk o unikalnym mechanizmie (czÄ™Å›ciowy agonista D2). Poprawia motywacjÄ™ i napÄ™d przy objawach negatywnych schizofrenii.",
    "Fluoksetyna": "Popularny lek z grupy SSRI. DziaÅ‚a przeciwdepresyjnie i przeciwlÄ™kowo, pomaga teÅ¼ w kontroli impulsÃ³w.",
    "Lit": "Klasyczny stabilizator nastroju. Najskuteczniejszy w profilaktyce nawrotÃ³w manii i depresji w chorobie afektywnej dwubiegunowej.",
    "Naltrekson": "Bloker receptorÃ³w opioidowych. Zmniejsza uczucie przymusu i euforii w uzaleÅ¼nieniach od alkoholu i opioidÃ³w.",
    "Memantyna": "Antagonista receptora NMDA. Chroni komÃ³rki nerwowe przed toksycznym dziaÅ‚aniem glutaminianu, stosowana w zaawansowanym otÄ™pieniu.",
    "Trazodon": "Lek przeciwdepresyjny o dziaÅ‚aniu uspokajajÄ…cym i nasennym. Skuteczny w leczeniu depresji z lÄ™kiem i bezsennoÅ›ciÄ….",
    "Galantamina": "Inhibitor acetylocholinesterazy, podobnie jak donepezil, stosowany w leczeniu otÄ™pienia.",
    "Kwasy omega-3": "WspomagajÄ… zdrowie naczyÅ„ krwionoÅ›nych w mÃ³zgu, co moÅ¼e byÄ‡ korzystne w otÄ™pieniu naczyniowym."
};

// =================================================================================
// KONFIGURACJA I ZMIENNE GLOBALNE
// =================================================================================
const TILE_SIZE = 32;
const MAP_COLS = 25;
const MAP_ROWS = 18;
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

canvas.width = MAP_COLS * TILE_SIZE;
canvas.height = MAP_ROWS * TILE_SIZE;
document.getElementById('canvasWrapper').style.width = `${canvas.width}px`;
document.getElementById('canvasWrapper').style.height = `${canvas.height}px`;

const knowledgeUI = document.getElementById('knowledge');
const medsUI = document.getElementById('meds');
const patientsProgressUI = document.getElementById('patients-progress');
const modalContainer = document.getElementById('modal-container');
const modalMessage = document.getElementById('modal-message');
const modalQuestion = document.getElementById('modal-question');
const modalButtons = document.getElementById('modal-buttons');
const modalFeedback = document.getElementById('modal-feedback');
const modalOkBtn = document.getElementById('modal-ok');

const TILES = { FLOOR: 0, WALL: 1, PLAYER: 2, KNOWLEDGE: 3, MEDS: 4, PATIENT: 5 };
const COLORS = { WALL: '#4a5568', FLOOR: '#cbd5e0', PLAYER: '#4299e1', KNOWLEDGE: '#f6e05e', MEDS: '#f56565', PATIENT: '#48bb78' };

const gameMap = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,2,0,0,1,3,0,0,1,0,0,0,0,0,0,1,5,0,0,0,1,3,0,0,1],
    [1,0,0,4,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,1,0,0,4,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,0,1,1,1,0,1,1,4,0,1,0,1,1,1,0,1,1,1,0,1,1,1],
    [1,4,0,0,1,0,0,0,1,0,0,0,0,0,1,5,0,0,0,0,0,0,0,4,1],
    [1,0,0,0,1,0,3,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,4,0,0,0,0,1,0,0,0,0,0,4,0,0,0,1],
    [1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,1],
    [1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,1,1,1,1,1,1,5,1,1,1,1,1,0,1,1,1,1,1,1,1,1],
    [1,0,0,0,1,4,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,4,0,0,1],
    [1,0,0,0,1,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,1,0,3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,5,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,1],
    [1,0,0,0,1,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
];

let player, gameState, totalPatients, medsOnMap, gamePaused, currentPatientCondition;

// =================================================================================
// INICJALIZACJA I GÅÃ“WNA LOGIKA
// =================================================================================
function init() {
    player = { x: 0, y: 0 };
    gameState = { knowledge: 0, meds: 0, patientsHelped: 0 };
    totalPatients = 0;
    medsOnMap = 0;
    gamePaused = false;
    currentPatientCondition = null;

    for (let row = 0; row < MAP_ROWS; row++) {
        for (let col = 0; col < MAP_COLS; col++) {
            const tile = gameMap[row][col];
            if (tile === TILES.PLAYER) {
                player.x = col;
                player.y = row;
                gameMap[row][col] = TILES.FLOOR;
            } else if (tile === TILES.PATIENT) {
                totalPatients++;
            } else if (tile === TILES.MEDS) {
                medsOnMap++;
            }
        }
    }
    
    updateUI();
    drawGame();
}

function movePlayer(dx, dy) {
    const nextX = player.x + dx;
    const nextY = player.y + dy;

    if (nextY < 0 || nextY >= MAP_ROWS || nextX < 0 || nextX >= MAP_COLS || gameMap[nextY][nextX] === TILES.WALL) {
        return;
    }

    player.x = nextX;
    player.y = nextY;
    checkInteraction();
    drawGame();
}

function checkInteraction() {
    const tile = gameMap[player.y][player.x];
    switch(tile) {
        case TILES.KNOWLEDGE:
            gameState.knowledge++;
            gameMap[player.y][player.x] = TILES.FLOOR;
            showKnowledgeModal();
            break;
        case TILES.MEDS:
            gameState.meds++;
            medsOnMap--; // Zmniejsz liczbÄ™ lekÃ³w na mapie
            gameMap[player.y][player.x] = TILES.FLOOR;
            showMedsModal();
            break;
        case TILES.PATIENT:
            triggerPatientEncounter();
            break;
    }
    updateUI();
}

window.addEventListener('keydown', (e) => {
    if (gamePaused && modalContainer.style.display === 'flex' && modalOkBtn.style.display !== 'none') {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            modalOkBtn.click();
            return;
        }
    }

    if (gamePaused) {
        return;
    }

    let dx = 0, dy = 0;
    switch(e.key) {
        case 'ArrowUp': dy = -1; break;
        case 'ArrowDown': dy = 1; break;
        case 'ArrowLeft': dx = -1; break;
        case 'ArrowRight': dx = 1; break;
        default: return;
    }
    e.preventDefault();
    movePlayer(dx, dy);
});

// =================================================================================
// RYSOWANIE
// =================================================================================
function drawGame() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let row = 0; row < MAP_ROWS; row++) {
        for (let col = 0; col < MAP_COLS; col++) {
            const tile = gameMap[row][col];
            let color;
            switch(tile) {
                case TILES.WALL: color = COLORS.WALL; break;
                case TILES.KNOWLEDGE: color = COLORS.KNOWLEDGE; break;
                case TILES.MEDS: color = COLORS.MEDS; break;
                case TILES.PATIENT: color = COLORS.PATIENT; break;
                default: color = COLORS.FLOOR;
            }
            drawTile(col, row, color);
            if (tile === TILES.KNOWLEDGE) drawSymbol(col, row, 'ğŸ§ ');
            if (tile === TILES.MEDS) drawSymbol(col, row, 'ğŸ’Š');
            if (tile === TILES.PATIENT) drawSymbol(col, row, 'ğŸ§‘');
        }
    }
    drawTile(player.x, player.y, COLORS.PLAYER);
    drawSymbol(player.x, player.y, 'ğŸ‘¨â€âš•ï¸');
}

function drawTile(x, y, color) {
    ctx.fillStyle = color;
    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
}

function drawSymbol(x, y, symbol) {
    ctx.font = `${TILE_SIZE * 0.7}px sans-serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(symbol, x * TILE_SIZE + TILE_SIZE / 2, y * TILE_SIZE + TILE_SIZE / 2);
}

// =================================================================================
// LOGIKA MODALI I UI
// =================================================================================
function updateUI() {
    knowledgeUI.textContent = gameState.knowledge;
    medsUI.textContent = gameState.meds;
    patientsProgressUI.textContent = `${gameState.patientsHelped}/${totalPatients}`;
}

function showKnowledgeModal() {
    gamePaused = true;
    const knowledgeItem = medicalData[Math.floor(Math.random() * medicalData.length)];
    modalMessage.textContent = `Nowa wiedza: ${knowledgeItem.name}`;
    modalQuestion.innerHTML = `<strong>Opis:</strong> ${knowledgeItem.info}<br><br><strong>Leki wskazane:</strong> ${knowledgeItem.recommended.join(', ')}<br><strong>Leki przeciwwskazane:</strong> ${knowledgeItem.contraindicated.join(', ')}`;
    modalButtons.innerHTML = '';
    modalFeedback.style.display = 'none';
    modalOkBtn.style.display = 'block';
    modalOkBtn.onclick = () => { gamePaused = false; modalContainer.style.display = 'none'; };
    modalContainer.style.display = 'flex';
}

function showMedsModal() {
    gamePaused = true;
    const drugNames = Object.keys(drugInfos);
    const randomDrug = drugNames[Math.floor(Math.random() * drugNames.length)];
    modalMessage.textContent = `Zebrano lek: ${randomDrug}`;
    modalQuestion.innerHTML = `<strong>DziaÅ‚anie:</strong> ${drugInfos[randomDrug]}`;
    modalButtons.innerHTML = '';
    modalFeedback.style.display = 'none';
    modalOkBtn.style.display = 'block';
    modalOkBtn.onclick = () => { gamePaused = false; modalContainer.style.display = 'none'; };
    modalContainer.style.display = 'flex';
}

function triggerPatientEncounter() {
    if (gameState.meds < 1) {
        showInfoModal("Brak lekÃ³w!", "Potrzebujesz co najmniej 1 jednostki lekÃ³w, aby pomÃ³c pacjentowi. ZnajdÅº je!");
        return;
    }
    
    gamePaused = true;
    currentPatientCondition = medicalData[Math.floor(Math.random() * medicalData.length)];
    
    modalMessage.textContent = "Pacjent potrzebuje pomocy!";
    modalQuestion.textContent = `Pacjent cierpi na: "${currentPatientCondition.name}". KtÃ³ry lek naleÅ¼y podaÄ‡?`;
    
    const correctAnswer = currentPatientCondition.recommended[0];
    const allDrugs = Object.keys(drugInfos);
    const wrongAnswers = allDrugs
        .filter(drug => !currentPatientCondition.recommended.includes(drug))
        .sort(() => 0.5 - Math.random())
        .slice(0, 3);
        
    const options = [correctAnswer, ...wrongAnswers].sort(() => 0.5 - Math.random());
    
    modalButtons.innerHTML = '';
    options.forEach(option => {
        const button = document.createElement('button');
        button.textContent = option;
        button.className = 'modal-button option-button';
        button.onclick = () => handlePatientAnswer(option === correctAnswer);
        modalButtons.appendChild(button);
    });

    modalFeedback.style.display = 'none';
    modalOkBtn.style.display = 'none';
    modalContainer.style.display = 'flex';
}

function handlePatientAnswer(isCorrect) {
    modalButtons.innerHTML = '';
    modalFeedback.style.display = 'block';
    gameState.meds--;

    if (isCorrect) {
        gameState.patientsHelped++;
        modalFeedback.textContent = "PrawidÅ‚owa odpowiedÅº! Pacjent czuje siÄ™ lepiej.";
        modalFeedback.className = 'feedback-correct';
        gameMap[player.y][player.x] = TILES.FLOOR;
    } else {
        modalFeedback.textContent = "Niestety, to zÅ‚a odpowiedÅº. Lek zostaÅ‚ zuÅ¼yty, ale pacjent nie poczuÅ‚ siÄ™ lepiej.";
        modalFeedback.className = 'feedback-incorrect';
    }
    
    updateUI();
    modalOkBtn.style.display = 'block';
    modalOkBtn.onclick = () => {
        gamePaused = false;
        modalContainer.style.display = 'none';
        drawGame();
        if (!checkWinCondition()) {
            checkLoseCondition();
        }
    };
}

function showInfoModal(title, message) {
    gamePaused = true;
    modalMessage.textContent = title;
    modalQuestion.textContent = message;
    modalButtons.innerHTML = '';
    modalFeedback.style.display = 'none';
    modalOkBtn.style.display = 'block';
    modalOkBtn.onclick = () => {
        gamePaused = false;
        modalContainer.style.display = 'none';
    };
    modalContainer.style.display = 'flex';
}

function showGameOverModal(title, message) {
    gamePaused = true;
    modalMessage.textContent = title;
    modalQuestion.textContent = message;
    modalButtons.innerHTML = '';
    modalFeedback.style.display = 'none';
    modalOkBtn.textContent = "Zagraj ponownie";
    modalOkBtn.style.display = 'block';
    modalOkBtn.onclick = () => location.reload();
    modalContainer.style.display = 'flex';
}

function checkWinCondition() {
    if (gameState.patientsHelped === totalPatients && totalPatients > 0) {
        showGameOverModal("Gratulacje!", "UkoÅ„czyÅ‚eÅ› misjÄ™! PomogÅ‚eÅ› wszystkim pacjentom. Szpital jest bezpieczny dziÄ™ki Tobie!");
        return true;
    }
    return false;
}

function checkLoseCondition() {
    const remainingPatients = totalPatients - gameState.patientsHelped;
    const potentialMeds = gameState.meds + medsOnMap; // Leki w ekwipunku + leki na mapie
    if (remainingPatients > 0 && potentialMeds < remainingPatients) {
        showGameOverModal("Koniec gry", "Nawet zbierajÄ…c wszystkie pozostaÅ‚e leki, nie bÄ™dziesz w stanie pomÃ³c wszystkim pacjentom. SprÃ³buj ponownie!");
    }
}

// =================================================================================
// START GRY
// =================================================================================
init();
</script>
</body>
</html>
